<%- include('partials/header'); -%>

    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand"></a>
                <form class="d-flex">
            </div>
            </form>
        </nav>

        <div class="row">
            <div class="col-4">
                <div class="list-group" id="list-tab" role="tablist">
                    <a class="list-group-item list-group-item-action block" id="home" data-toggle="list"
                        href="#list-home" role="tab" aria-controls="home">Change password</a>
                    <a class="list-group-item list-group-item-action block" id="email" data-toggle="list"
                        href="#list-email" role="tab" aria-controls="email">Change email</a>
                    <a class="list-group-item list-group-item-action block" id="settings" data-toggle="list"
                        href="#list-settings" role="tab" aria-controls="settings">Settings</a>
                    <a class="list-group-item list-group-item-action block" id="fav" data-toggle="list"
                        href="#list-favs" role="tab" aria-controls="fav">Favourites</a>
                </div>
            </div>


            <div class="col-8">
                <div class="tab-content" id="nav-tabContent">
                    <!-- Change password -->
                    <div class="tab-pane fade show block" id="list-home" role="tabpanel"
                        aria-labelledby="list-home-list">
                        <div class="card bg-light">
                            <article class="card-body mx-auto" style="max-width: 400px;">
                                <h4 class="card-title mt-3 text-center pb-3">Change password</h4>
                                <form class="password-form">

                                    <!-- Enter current email -->
                                    <div class="form-group input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"> <i class="fa fa-lock"></i> </span>
                                        </div>
                                        <input class="form-control" placeholder="Current Email" type="text"
                                            name="email">
                                    </div>

                                    <!-- Enter new password -->
                                    <div class="form-group input-group pt-3 pb-3">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"> <i class="fa fa-lock"></i> </span>
                                        </div>
                                        <input class="form-control" placeholder="New password" type="password"
                                            name="password">
                                    </div>

                                    <!-- Confirm new password -->
                                    <!--
                            <div class="form-group input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"> <i class="fa fa-lock"></i> </span>
                                </div>
                                <input class="form-control" placeholder="Repeat password" type="password">
                            </div> 
                        -->

                                    <!-- Submit button -->
                                    <div class="d-flex form-group pt-3 justify-content-center">
                                        <button type="submit" class="btn btn-primary btn-block">Update</button>
                                    </div>
                                </form>
                            </article>
                        </div>
                    </div>
                    <!-- Change email -->
                    <div class="tab-pane fade show block" id="list-email" role="tabpanel"
                        aria-labelledby="list-email-list">
                        <div class="card bg-light">
                            <article class="card-body mx-auto" style="max-width: 400px;">
                                <h4 class="card-title mt-3 text-center pb-3">Change Email</h4>
                                <form class="email-form">
                                    <!-- Enter current email -->
                                    <div class="form-group input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"> <i class="fa fa-envelope"></i> </span>
                                        </div>
                                        <input class="form-control" placeholder="Enter current email" type="text" name="currentemail">
                                    </div>
                                    <!-- Enter new email -->
                                    <div class="form-group input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"> <i class="fa fa-envelope"></i> </span>
                                        </div>
                                        <input class="form-control" placeholder="New Email" type="text" name="newemail">
                                    </div>
                                    <!-- Enter current password -->
                                    <div class="form-group input-group pt-3 pb-3">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"> <i class="fa fa-lock"></i> </span>
                                        </div>
                                        <input class="form-control" placeholder="Current Password" type="password"
                                            name="password">
                                    </div>
                                    

                                    <!-- Submit button -->
                                    <div class="d-flex form-group pt-3 justify-content-center">
                                        <button type="submit" class="btn btn-primary btn-block">Edit</button>
                                    </div>
                                </form>
                            </article>
                        </div>
                    </div>
                    <!-- Settings -->
                    <div class="tab-pane fade show block" id="list-settings" role="tabpanel"
                        aria-labelledby="list-settings-list">
                        <div class="card bg-light">
                            <article class="card-body mx-auto" style="max-width: 400px;">
                                <h4 class="card-title mt-3 text-center pb-3">Settings</h4>
                                <form>
                                    <!-- Settings -->
                                    <div class="form-group input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"> <i class="fa fa-envelope"></i> </span>
                                        </div>
                                        <input class="form-control" placeholder="<!-PLACEHOLDER->" type="text">
                                    </div>

                                    <!-- Submit button -->
                                    <div class="d-flex form-group pt-3 justify-content-center">
                                        <button type="submit" class="btn btn-primary btn-block">Edit</button>
                                    </div>
                                </form>
                            </article>
                        </div>
                    </div>
                     <!--Favourites page-->
                     <div class="tab-pane fade show block" id="list-fav" role="tabpanel" aria-labelledby="list-fav-list">
                        <div class="card bg-light">
                            <article class="card-body mx-auto" style="max-width: 400px;">
                                <h4 class="card-title mt-3 text-center pb-3">
                                    <%=title%>
                                </h4>
                                <form>
                                    <%if ((userdata.length>0)){ %>
                                        <% userdata.forEach(function(row){ %>
                                            <% if((row.id !=null) && (row.email==users_email)){ %>

                                                <li
                                                    class="list-group-item d-flex justify-content-between align-items-start">
                                                    <div class="ms-2 me-auto" style="max-width: 70%;">
                                                        <div class="fw-lighter" id="job-title">
                                                            <%= row.company%>
                                                        </div>
                                                        <div class="fs-5">
                                                            <%=row.jobTitle%>
                                                        </div>
                                                        <div class="fs-6"
                                                            style="max-width: 90%; overflow: hidden; max-height: 50px">
                                                            <%=row.summary%>
                                                        </div>
                                                    </div>
                                                    <div class="userButton">
                                                        <button onclick="button('<%=row._id%>')" type="button1"
                                                            id="button1" class="btn btn-outline-primary">-</button>

                                                    </div>
                                                    <a href=<%=row.link%>>
                                                        <button type="button" class="btn btn-primary"
                                                            data-bs-toggle="modal">Apply</button>
                                                    </a>
                                                </li>
                                                <%}%>
                                                    <% })%>
                                                        <%}%>
                        </div>
                </div>
                <!--<div class="tab-pane fade " id="list-settings" role="tabpanel" aria-labelledby="list-settings-list"></div>-->
            </div>
        </div>

        <%- include('partials/footer'); -%>

            <!-- Navbar JavaScript -->

            <script>
                let profile = document.getElementById("home") // 'Change password'
                let email = document.getElementById("email") // 'Change email'
                let settings = document.getElementById("settings") // 'Settings'
                let favourites = document.getElementById("fav") //favoutites

                profile.addEventListener("click", userPassword)
                email.addEventListener('click', userEmail)
                settings.addEventListener("click", userSettings)
                favourites.addEventListener("click", fav_user_page)

                /*
                    Change Password
                */
                const form = document.querySelector('.password-form')
                //const emailError = document.querySelector('.email.error')
                //const passwordError = document.querySelector('.password.error')

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // reset errors
                    //emailError.textContent = ''
                    //passwordError.textContent = ''

                    // get the values
                    //const email = form.email.value
                    const password = form.password.value
                    const email = form.email.value

                    try {
                        const res = await fetch('/password', {
                            method: 'POST',
                            body: JSON.stringify({
                                email,
                                password,
                            }),
                            headers: { 'Content-Type': 'application/json' }
                        })
                        const data = await res.json()
                        if (data.isPasswordChanged) {
                            location.assign('/login')
                        }
                    } catch (err) {
                        console.log(err)
                    }
                })
                /*
                * Change email
                */
                const emailForm = document.querySelector('.email-form')
                //const emailError = document.querySelector('.email.error')
                //const passwordError = document.querySelector('.password.error')

                emailForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // reset errors
                    //emailError.textContent = ''
                    //passwordError.textContent = ''

                    // get the values
                    //const email = form.email.value
                    const currentEmail = emailForm.currentemail.value
                    const newEmail = emailForm.newemail.value
                    const password = emailForm.password.value

                    try {
                        const res = await fetch('/email', {
                            method: 'POST',
                            body: JSON.stringify({
                                currentEmail,
                                newEmail,
                                password,
                            }),
                            headers: { 'Content-Type': 'application/json' }
                        })
                        const data = await res.json()
                        if (data.isEmailChanged) {
                            alert('Your email has been updated, click OK to return to login page')
                            location.assign('/login')
                        } else if (data.wrongFormat) {
                            alert('Your new email is not in email formating. E.g. (example@example.com)')
                            location.assign('/profile')
                        } else if (data.sameEmail) {
                            alert('You cannot change the same email')
                            location.assign('/profile')
                        } else if (data.emailTaken) {
                            alert('Sorry, that email is already taken. Please enter a different email.')
                            location.assign('profile')
                        } else {
                            alert('Your current email or password is incorrect')
                            location.assign('/profile')
                        }
                    } catch (err) {
                        console.log(err)
                    }
                })

                async function button(a) {
                    var _id = ''
                    var id = ''
                    var jobTitle = ''
                    var company = ''
                    var summary = ''
                    var salary = ''
                    var locations = ''
                    var time = ''
                    var link = ''
                    var email = ''

                    var data_length = parseInt('<%=userdata.length%>')
                    '<% userdata.forEach(function(row){ %>'
                    if ('<%=row._id%>' == a) {
                        _id = '<%=row._id%>'
                        id = '<%=row.id%>'
                        jobTitle = '<%=row.jobTitle%>'
                        company = '<%=row.company%>'
                        summary = '<%=row.summary%>'
                        salary = '<%=row.salary%>'
                        locations = '<%=row.locations%>'
                        time = '<%=row.time%>'
                        link = '<%=row.link%>'
                        email = '<%=row.email%>'
                    }
                    '<%})%>'
                    try {
                        const res = await fetch('/delete', {
                            method: 'DELETE',
                            body: JSON.stringify({ _id, id, jobTitle, company, summary, salary, locations, time, link, email }),
                            headers: { 'Content-Type': 'application/json' }
                        })
                        const data = await res.json()
                        // console.log(data)   

                        location.assign('/profile')

                        if (data.errors) {
                        }
                    } catch (err) {
                        console.log(err)
                    }
                }

                /**
                * Navigation JavaScript
                **/
                // Password
                function userPassword() {

                    // Email tab not active
                    let emailTab = document.getElementById('email')
                    emailTab.className = emailTab.className.replace('active', 'block')
                    // Email content not active
                    let emailContent = document.getElementById('list-email')
                    emailContent.className = emailContent.className.replace('active', 'block')

                    // not active Settings tab
                    let userSettingsChange = document.getElementById('settings')
                    userSettingsChange.className = userSettingsChange.className.replace('active', 'block')
                    // not active Settings content
                    let userTab = document.getElementById('list-settings')
                    userTab.className = userTab.className.replace('active', 'block')

                      // not active Favourites tab
                      let fav_page = document.getElementById('fav')
                    fav_page.className = fav_page.className.replace('active', 'block')
                    // not active Favourites content
                    let fav_content = document.getElementById('list-fav')
                    fav_content.className = fav_content.className.replace('active', 'block')

                    // Profile tab
                    let maptab = document.getElementById('home')
                    maptab.className = maptab.className.replace('block', 'active')
                    // Profile content
                    let showProfile = document.getElementById('list-home')
                    showProfile.className = showProfile.className.replace('block', 'active')


                }

                //Email
                function userEmail() {
                    //not active password
                    let changePass = document.getElementById('home')
                    changePass.className = changePass.className.replace('active', 'block')
                    //Not active pasword content
                    let userProfile = document.getElementById('list-home')
                    userProfile.className = userProfile.className.replace('active', 'block')

                    // not active Settings tab
                    let userSettingsChange = document.getElementById('settings')
                    userSettingsChange.className = userSettingsChange.className.replace('active', 'block')
                    // not active Settings content
                    let userTab = document.getElementById('list-settings')
                    userTab.className = userTab.className.replace('active', 'block')

                     // not active Favourites tab
                     let fav_page = document.getElementById('fav')
                    fav_page.className = fav_page.className.replace('active', 'block')
                    // not active Favourites content
                    let fav_content = document.getElementById('list-fav')
                    fav_content.className = fav_content.className.replace('active', 'block')

                    // Email tab
                    let maptab = document.getElementById('email')
                    maptab.className = maptab.className.replace('block', 'active')
                    // Email content
                    let showProfile = document.getElementById('list-email')
                    showProfile.className = showProfile.className.replace('block', 'active')
                }

                //Settings
                function userSettings() {

                    //not active password
                    let changePass = document.getElementById('home')
                    changePass.className = changePass.className.replace('active', 'block')
                    //Not active pasword content
                    let userProfile = document.getElementById('list-home')
                    userProfile.className = userProfile.className.replace('active', 'block')

                    // Email tab not active
                    let emailTab = document.getElementById('email')
                    emailTab.className = emailTab.className.replace('active', 'block')
                    // Email content not active
                    let emailContent = document.getElementById('list-email')
                    emailContent.className = emailContent.className.replace('active', 'block')

                     // not active Favourites tab
                     let fav_page = document.getElementById('fav')
                    fav_page.className = fav_page.className.replace('active', 'block')
                    // not active Favourites content
                    let fav_content = document.getElementById('list-fav')
                    fav_content.className = fav_content.className.replace('active', 'block')

                    // Settings tab
                    let userSettingsChange = document.getElementById('settings')
                    userSettingsChange.className = userSettingsChange.className.replace('block', 'active')
                    // Settings content
                    let userTab = document.getElementById('list-settings')
                    userTab.className = userTab.className.replace('block', 'active')

                }

                function fav_user_page() {
                    //not active password
                    let changePass = document.getElementById('home')
                    changePass.className = changePass.className.replace('active', 'block')
                    //Not active pasword content
                    let userProfile = document.getElementById('list-home')
                    userProfile.className = userProfile.className.replace('active', 'block')
                    // Email tab not active
                    let emailTab = document.getElementById('email')
                    emailTab.className = emailTab.className.replace('active', 'block')
                    // Email content not active
                    let emailContent = document.getElementById('list-email')
                    emailContent.className = emailContent.className.replace('active', 'block')
                    // not active Settings tab
                    let userSettingsChange = document.getElementById('settings')
                    userSettingsChange.className = userSettingsChange.className.replace('active', 'block')
                    // not active Settings content
                    let userTab = document.getElementById('list-settings')
                    userTab.className = userTab.className.replace('active', 'block')
                    // not active Favourites tab
                    let fav_page = document.getElementById('fav')
                    fav_page.className = fav_page.className.replace('block', 'active')
                    // not active Favourites content
                    let fav_content = document.getElementById('list-fav')
                    fav_content.className = fav_content.className.replace('block', 'active')
                }

                var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
                (function () {
                    var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
                    s1.async = true;
                    s1.src = 'https://embed.tawk.to/60ab0ec7a4114e480ad07c92/1f6e33eqn';
                    s1.charset = 'UTF-8';
                    s1.setAttribute('crossorigin', '*');
                    s0.parentNode.insertBefore(s1, s0);
                })();
            </script>