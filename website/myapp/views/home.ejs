<%- include('partials/header'); -%>

<body>
  <div
    class="cover-container d-flex h-100 p-5 mx-auto flex-column text-center m-5"
  >
    <main role="main" class="inner cover">
      <h1 class="cover-heading">Find all the junior software jobs.</h1>
      <p class="lead">JobSpy will help you find a junior job etc.</p>
      <div class="input-group rounded">
        <form class="d-flex mx-auto">
          <input
            class="form-control me-2"
            type="search"
            placeholder="Search for a job"
            aria-label="Search"
          />
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
      </div>
    </main>
  </div>
  <div class="recent-job-list" data-url="/data" style="padding-bottom: 30px">
    <p class="lead text-center">Recent Job Listings:</p>
    <ol class="list-group list-group w-50 mx-auto">
      <div id="results" class=""></div>
    </ol>
  </div>
  <script>
    {
      /**
       * Populates the job list with most recent jobs from DB
       */
      async function listRecentJobs() {
        const response = await fetch('/data')
        let jobList = ''

        const data = await response.json()

        // List of tags which will be applied to each job listing if they contain the matching keyword
        let tagDirectory = [
          '.NET',
          'JavaScript',
          'React',
          'Frontend',
          'Angular',
          'Backend',
          'C#',
          'AWS',
          'Azure',
          'Front End',
          'Full Stack',
          'Fullstack',
          'Junior',
          'Intern',
          'Internship',
          'TypeScript',
          'Senior',
          'Intermediate',
          'Python',
          'Graduate',
          'Mobile',
          'iOS',
          'Android',
        ]

        const numOfJobsToDisplay = 4
        for (i = 0; i < numOfJobsToDisplay; i++) {
          jobList += `
                <div class="modal fade" id="thanksModal" tabindex="-1" aria-labelledby="thanksModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="thanksModalLabel">Thank you for reporting.</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        If we find this content is inappropriate, we will remove it.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                    </div>
                </div>
                </div>

            <div class="modal fade" id="modal${[
              i,
            ]}" tabindex="-1" aria-labelledby="applyModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content ">
                    <div class="modal-header">
                        <div class="fw-lighter" id="job-title"><p></p></div>
                        <h5 class="modal-title" id="applyModalLabel"><div class="fw-lighter fs-6">${
                          data[i].company
                        }</div> ${data[i].jobTitle}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            ${data[i].summary}
                        </p>
                        <div  class="fw-light">Is this content inappropriate? <a onclick="report('A user', '${
                          data[i]._id
                        }, ${data[i].jobTitle}, ${data[i].company}, ${
            data[i].summary
          }: ${
            data[i].link
          }')" href="#" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#thanksModal">Report</a>.</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-primary">♡</button>
                        <a href="${
                          data[i].link
                        }"><button type="button" class="btn btn-primary">Apply</button></a>
                    </div>
                </div>
            </div>
        </div>

            <div style="padding-top: 10px">
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto" style="max-width: 70%;">
                        <div class="fw-lighter" id="job-title">${
                          data[i].company
                        }</div>
                        <div class="fs-5">${data[i].jobTitle}</div>
                        <div class="fs-6" style="max-width: 90%; overflow: hidden; max-height: 50px">${
                          data[i].summary
                        }</div> `

          // Assigns each job tags if keywords found in tagDirectory can be matched job's against title & summary
          for (let tagIndex = 0; tagIndex < tagDirectory.length; tagIndex++) {
            if (
              (
                data[i].jobTitle.toLowerCase() || data[i].summary.toLowerCase()
              ).includes(tagDirectory[tagIndex].toLowerCase())
            ) {
              jobList += `
        <span class="badge rounded-pill bg-primary">${tagDirectory[tagIndex]}</span> `
            }
          }

          jobList += ` </div>
                    <div class="mx-2 my-auto">
                        <button type="button" class="btn btn-outline-primary">♡</button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#modal${[i]}">Apply</button>
                    </div>
                  </div>
              </li>
          </div>
            `
        }

        document.getElementById('results').innerHTML = jobList
      }

      async function promptReport() {
        let dialogue = ''
      }

      listRecentJobs()

      /**
       * Send POST request to server with report data
       */
      async function report(user, url) {
        const data = { user, url }
        console.log(url)
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        }
        const response = await fetch('/report', options)
      }
    }
  </script>

  <%- include('partials/footer'); -%>
</body>
